Графический пользовательский интерфейс
======================================

Концептуальная модель
---------------------

Графический интерфейс пользователя это композиция набора повторяющихся элементов (окна, кнопки, поля ввода и т.д.).

Видимый элемент - это любой элемент программы,  который виден
на экране и все эти элементы являются объектами.
Поля, рамки
окон, полосы скроллинга,  полосы меню и диалоговые окна -  это  все
видимые элементы. Видимый элемент всегда  прямоугольный.

Видимые элементы можно структурировать в виде иерархии. Они   могут   объединяться   для
формирования более сложных элементов таких,  как окна и  диалоговые
окна. Существуют специальные элементы, которые могут включать другие элементы, в том числе другие группы элементов. Эти  группы  видимых  элементов  работают вместе  так,  как  если   бы   это   был   один   элемент. Если иерархия меняется, то меняется внешний вид. Перерисовка изменившихся частей интерфейса происходит автоматически.

Сам интерфейс определяется декларативно в виде разметки, которая отражает иерархию видимых элементов.

Базовые элементы
^^^^^^^^^^^^^^^^

:text: элемент с текстом
       (text <строка текста> <атрибут1> <атрибут2> ...)
:image: изображение
	(image <объект изображения> <атрибут1> <атрибут2> ...)


Групповые элементы
^^^^^^^^^^^^^^^^^^

:block: прямоугольная область, может иметь вложенные дочерние элементы, необходимо указывать координаты внутренних элементов
	(block <атрибут1> <атрибут2> ... <элемент1> <элемент2> ...)
:vert: внутренние элементы располагаются по вертикали, ширина и высота группы вычисляется автоматически
       	(vert <элемент1> <элемент2> ...)
:horiz: внутренние элементы располагаются по горизонтали, ширина и высота группы вычисляется автоматически
	(horiz <элемент1> <элемент2> ...)

Атрибуты видимых элементов
^^^^^^^^^^^^^^^^^^^^^^^^^^

:id: Идентификатор объекта для поиска.
:x: Координата x элемента, всегда относительно левого верхнего угла родителя
:y: Координата y элемента, всегда относительно левого верхнего угла родителя
:width: Ширина объекта.
:height: Высота объекта.
:back-color: Цвет фона (задаётся по умолчанию для разных типов объектов).
:active-color: Цвет фона для активного элемента (задаётся по умолчанию для разных типов объектов).
:keydown: Функция для обработки нажатия клавиши (параметр - код клавиши)
:keyup: Функция для обработки отпускания клавиши (параметр - код клавиши)


Функции для работы с деревом объектов
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

:add-child par ch: Добавление дочернего элемента ch к родительскому par.
:remove-child par ch: Удаление дочернего элемента ch у родительского par.
:get-element-by-id elem-id: Возвращает элемент, у которого id равен elem-id.

Пример.			    
::

   (setq w (block (id 1) (width 100) (height 100)))
   (setq b (text "Ok" (id 2) (x 10) (y 20)))
   (add-child w b)
   (remove-child (get-element-by-id 1) (get-element-by-id 2))

Обработчики событий
^^^^^^^^^^^^^^^^^^^

Событие -  это  что-то,   на   что   программа   должна
отреагировать. События могут приходить от клавиатуры,  от мышки или
от других частей программы.

В один момент времени активен только один элемент, по клавише tab происходит смена активного элемента на следующий в иерархии.

Пользователь может задать обработчики событий программно:

:onkeydown: (onkeydown <элемент интерфейса> <функция обработчик события>)
            Задает функцию которая запускается по нажатию клавиши
:onkeyup: (onkeyup <элемент интерфейса> <функция обработчик события>)
          Задает функцию которая запускается по отжатию клавиши

Событие распространяется от дочернего элемента к родительскому.

Пример кода:
::
   
   (onkeydown (get-object-by-id 'main-window) '#(lambda (key) (print key)))

Отображение интерфейса на экране
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Функция set-screen принимает на вход дерево видимых элементов и отображает его.
::

   (set-screen
       (vert ; вертикальная группа
	   (text "Test" (id 1)) ; текст
	   (horiz ; горизонтальная группа
	       (block (width 100) (height 100) (color 14) ; блок элементов
	            (text "Test2" (x 10) (y 20)) ; текстовое поле с абсолютными координатами
	       (block (width 10) (height 10) (backcolor 2) ; воображаемая кнопка
	            (keydown '#(lambda (k) ; функция обработчик нажатия клавиши
		                  (when (= k +enter+) ; если код Enter
				        ; меняем текст у первого элемента
				        (set-text (get-element-by-id 1) "TEST"))
					)))))))
			         
Реализация
----------

Цикл событий
^^^^^^^^^^^^

Очередь событий глобальная структура данных. В нее поступают события по мере возникновения аппаратных прерываний. Например обработчик прерывания клавиатуры добавляет в очередь событий новую запись: нажата клавиша Escape или отпущена клавиша Space. Событие нажатия клавиатуры состоит из типа события  (keydown, keyup) и скан кода нажатой клавиши.

Цикл бесконечен и каждую свою иттерацию он проверяет очередь событий на пустоту. Если очередь содержит элементы, то цикл получает первый элемент очереди и по типу события(keyup, keydown) сопостовляет его с соответствующей глобальной структурой,после чего находит в данном списке нужный подсписок по ключу(выбраный в данный моменть элемент интерфейса пользователем), после чего сопостовляет его с соответсвующим списком пользовательских событий из глобальной структуры по скан коду клавиши,после чего запускает пользовательские события храннящиеся в этом списке.

Список окон хранится в глобальной переменной \*window-list\*. Окна это экземпляры класса window. Все остальные элементы являются дочерними для окон. Позиция для добавления нового окна \*current-window-pos\*, например (10 . 0).

Класс element
^^^^^^^^^^^^^

Базовый класс для всех элементов - element, остальные элементы как базовые так и групповые наследуются от него.
В нем хранятся свойства: 

:x: Координата x (относительно левого верхнего угла родительского элемента)
:y: Координата y (относительно левого верхнего угла родительского элемента)
:width: Ширина элемента
:height: Высота элемента
:back-color: Цвет фона элемента
:active-color: Цвет фона, когда элемент активен
:parent: Родительский элемент 
:keydown: & Функция для обработки нажатия клавиши (параметр - код клавиши)
:keyup: & Функция для обработки отпускания клавиши (параметр - код клавиши)

Методы:

:draw el: Отрисовка элемента el на экране (по умолчанию прямоугольник)

Класс text
^^^^^^^^^^

Класс text служит для отображения текста на экране.
В нем хранятся свойства:

:text: выводимый на экран текст
:color: цвет текста

Методы:

:draw t: Переопределяет метод parent класса element для корректного отображения текстового элемента t в заданной области (текст переносится на следующую строкe если не помещается по ширине width)

Класс image
^^^^^^^^^^^

Класс image служит для отрисовки изображения на экране.
В нем хранятся свойства:

:pixelmatrix: матрица пикселей по которой будет строится изображение

Методы:

:draw img: Переопределяет метод parent класса element для отрисовки изображения img по матрице пикселей

Класс block
^^^^^^^^^^^

Класс block является групповым элементом и служит для группировки базовых элементов на экране по координатам.
В нем хранятся свойства:

:children: список дочерних элементов

Методы:

:draw bx: Переопределяет метод parent класса element для перерисовки всех дочерних элементов bx с учетом изменения его положения и размеров.
:add-child par ch: добавляет элемент ch в список children группового элемента par на последнее место

Класс vert
^^^^^^^^^^

Класс vert наследуется от box и служит для группировки базовых элементов, но при этом вместо размещения по координатам положение дочернего элемента вычисляется автоматически так, чтобы дочерние элементы группировались в столбик.
В нем хранятся свойства:

:padding: отступ между дочерними элементами по вертикали
:curpos: позиция для размещения следующего child элемента

Методы:

:add-child par ch: переопределяет метод родительского класса box, изменяет параметры x и y элемента ch, соответственно его размещению в par на позиции curpos, в зависимости от парметров padding элемента par а также height и width элемента ch перерасчитывает curpos элемента par по вертикали и добавляет ch в список children элемента par.


Класс horiz
^^^^^^^^^^^

Класс horiz наследуется от vert и служит для размещения элементов по горизонтали. Он не содержит оригинальных свойств.

Содержит методы:

:add-child par ch: переопределяет метод родительского класса vert, изменяет параметры x и y элемента ch, соответственно его размещению в par на позиции curpos, в зависимости от парметров padding элемента par а также height и width элемента ch перерасчитывает curpos элемента par по горизонтали и добавляет ch в список children элемента par.

Список id элементов
^^^^^^^^^^^^^^^^^^^

Для удобства доступа к определенным элементам интерфейса в отдельном файле хранится глобальный список ключ-значение где ключ это id элемента а значение ссылка на него, если пользователь хочет иметь доступ к элементу по id он должен добаить этот элемент в список и присвоить ему соответствующий id, для получения элемента из списка используется функция:

:reveal-id elem: создает пару ключ-значение id элемента (element-id elem) и самого элемента elem в глобальном списке, проверяя id на уникальность
:get-element-by-id elem-id: возвращает элемент у которого id равен elem-id

		   
Дерево компонентов
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Дерево компонентов - это композиция обьектов интерфейса размещаемых на экране, ветви дерева это children списки групповых элементов и сами групповые элементы помещенные в списки других им аналогичных.
Позиция в дереве отвечает за порядок отрисовки элементов, чем ближе элемент к корню дерева тем раньше он отрисовывается. Изменяя порядок элементов в списках children можно манипулировать тем какой элемент будет перекрывать другой на экране (например для реализации отображения выбранного окна поверх других).


Архитектура
-----------

Модуль gui/element.lsp - базовый класс element.

Модуль gui/text.lsp - класс текстового элемента.

Модуль gui/block.lsp - класс группы элементов.

Модуль gui/vert.lsp - класс вертикальной группы элементов.

Модуль gui/horiz.lsp - класс горизонтальной группы элементов.

Модуль x86/sys.c - функции для отрисовки.

